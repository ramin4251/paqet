name: Build and Release

on:
    workflow_dispatch:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    build-linux:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - goarch: amd64
                      filename: amd64
                      container: muslcc/x86_64:x86_64-linux-musl
                    - goarch: arm64
                      filename: arm64
                      container: muslcc/x86_64:aarch64-linux-musl
                    - goarch: arm
                      filename: arm32
                      container: muslcc/x86_64:arm-linux-musleabihf

        container:
            image: ${{ matrix.container }}

        steps:
            - name: Install Build Dependencies
              run: |
                  apk update
                  apk add --no-cache git bash tar gzip wget flex bison linux-headers make

            - name: Install Go
              run: |
                  GO_VERSION=1.26.0
                  GO_ARCH=amd64
                  
                  wget -q https://go.dev/dl/go${GO_VERSION}.linux-${GO_ARCH}.tar.gz
                  tar -C /usr/local -xzf go${GO_VERSION}.linux-${GO_ARCH}.tar.gz
                  rm go${GO_VERSION}.linux-${GO_ARCH}.tar.gz
                  
                  # Add Go to PATH
                  echo "/usr/local/go/bin" >> $GITHUB_PATH
                  export PATH=$PATH:/usr/local/go/bin

            - name: Checkout Code
              run: |
                  git config --global --add safe.directory $GITHUB_WORKSPACE
                  git clone --depth 1 --branch ${GITHUB_REF#refs/heads/} https://github.com/${{ github.repository }} . 2>/dev/null || \
                  git clone --depth 1 --branch ${GITHUB_REF#refs/tags/} https://github.com/${{ github.repository }} . 2>/dev/null || \
                  git clone https://github.com/${{ github.repository }} .
                  git checkout ${{ github.sha }}

            - name: Build Static libpcap
              run: |
                  set -e
                  
                  # Download libpcap
                  LIBPCAP_VERSION=1.10.6
                  wget -q https://www.tcpdump.org/release/libpcap-${LIBPCAP_VERSION}.tar.gz
                  tar -xzf libpcap-${LIBPCAP_VERSION}.tar.gz
                  cd libpcap-${LIBPCAP_VERSION}
                  
                  CC=gcc
                  if [ "${{ matrix.goarch }}" = "amd64" ]; then
                    HOST_FLAG=""
                  elif [ "${{ matrix.goarch }}" = "arm64" ]; then
                    HOST_FLAG="--host=aarch64-linux-musl"
                  elif [ "${{ matrix.goarch }}" = "arm" ]; then
                    HOST_FLAG="--host=arm-linux-musleabihf"
                  fi
                  
                  # Configure and build libpcap
                  ./configure ${HOST_FLAG} \
                    --prefix=/opt/libpcap \
                    --disable-shared \
                    --disable-dbus \
                    --disable-bluetooth \
                    --disable-usb \
                    --with-pcap=linux
                  
                  make -j$(nproc)
                  make install
                  
                  cd ..

            - name: Get tag or commit
              id: ref_id
              shell: bash
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    REF_ID="${GITHUB_REF#refs/tags/}"
                    echo "Triggered by tag: $REF_ID"
                  else
                    REF_ID=$(git rev-parse --short HEAD)
                    echo "No tag detected. Using commit hash: $REF_ID"
                  fi
                  echo "ref=$REF_ID" >> $GITHUB_OUTPUT

            - name: Build
              run: |
                  mkdir -p dist

                  export CGO_ENABLED=1 
                  export GOOS=linux 
                  export GOARCH=${{ matrix.goarch }}
                  export CC=gcc
                  export VERSION=${{ steps.ref_id.outputs.ref }}
                  export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
                  export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
                  export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
                  
                  # Set PKG_CONFIG_PATH for libpcap
                  export PKG_CONFIG_PATH=/opt/libpcap/lib/pkgconfig
                  export CGO_CFLAGS="-I/opt/libpcap/include"
                  export CGO_LDFLAGS="-L/opt/libpcap/lib -lpcap"

                  # Set GOARM for arm32
                  if [ "$GOARCH" = "arm" ]; then
                    export GOARM=7
                  fi

                  go build -v -a -trimpath \
                    -gcflags "all=-l=4" \
                    -ldflags "-s -w -buildid= -linkmode external -extldflags '-static' \
                    -X 'paqet/cmd/version.Version=${VERSION}' \
                    -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
                    -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
                    -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o paqet_linux_${{ matrix.filename }} ./cmd/main.go

                  chmod +x paqet_linux_${{ matrix.filename }}
                  tar -czvf dist/paqet-linux-${{ matrix.filename }}-${{ steps.ref_id.outputs.ref }}.tar.gz \
                    paqet_linux_${{ matrix.filename }} \
                    README.md \
                    example/client.yaml.example \
                    example/server.yaml.example

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: paqet-linux-${{ matrix.filename }}
                  path: dist/paqet-linux-${{ matrix.filename }}-${{ steps.ref_id.outputs.ref }}.tar.gz
                  retention-days: 7

    build-windows:
        runs-on: windows-latest
        strategy:
            matrix:
                goarch: [amd64]
        steps:
            - name: Setup Build Environment
              run: |
                  # Install Npcap for libpcap support on Windows
                  choco install npcap -y
                  # Install MinGW for CGO support
                  choco install mingw -y

            - name: Checkout Code
              uses: actions/checkout@v6

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version: "1.26"

            - name: Get tag or commit
              id: ref_id
              shell: bash
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    REF_ID="${GITHUB_REF#refs/tags/}"
                    echo "Triggered by tag: $REF_ID"
                  else
                    REF_ID=$(git rev-parse --short HEAD)
                    echo "No tag detected. Using commit hash: $REF_ID"
                  fi
                  echo "ref=$REF_ID" >> $GITHUB_OUTPUT

            - name: Build
              shell: bash
              run: |
                  mkdir -p dist
                  export CGO_ENABLED=1 
                  export GOOS=windows 
                  export GOARCH=${{ matrix.goarch }}
                  export VERSION=${{ steps.ref_id.outputs.ref }}
                  export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
                  export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
                  export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

                  go build -v -a -trimpath \
                    -gcflags "all=-l=4" \
                    -ldflags "-s -w -buildid= \
                    -X 'paqet/cmd/version.Version=${VERSION}' \
                    -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
                    -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
                    -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o paqet_windows_${{ matrix.goarch }}.exe ./cmd/main.go

                  7z a -tzip dist/paqet-windows-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.zip \
                    paqet_windows_${{ matrix.goarch }}.exe \
                    README.md \
                    example/client.yaml.example \
                    example/server.yaml.example

            - name: Upload Artifact
              uses: actions/upload-artifact@v6
              with:
                  name: paqet-windows-${{ matrix.goarch }}
                  path: dist/paqet-windows-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.zip
                  retention-days: 7

    build-darwin:
        runs-on: macos-latest
        strategy:
            matrix:
                goarch: [amd64, arm64]
        steps:
            - name: Checkout Code
              uses: actions/checkout@v6

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version: "1.26"

            - name: Get tag or commit
              id: ref_id
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    REF_ID="${GITHUB_REF#refs/tags/}"
                    echo "Triggered by tag: $REF_ID"
                  else
                    REF_ID=$(git rev-parse --short HEAD)
                    echo "No tag detected. Using commit hash: $REF_ID"
                  fi
                  echo "ref=$REF_ID" >> $GITHUB_OUTPUT

            - name: Build
              run: |
                  mkdir -p dist
                  export CGO_ENABLED=1 
                  export GOOS=darwin 
                  export GOARCH=${{ matrix.goarch }}
                  export VERSION=${{ steps.ref_id.outputs.ref }}
                  export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
                  export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
                  export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

                  go build -v -a -trimpath \
                    -gcflags "all=-l=4" \
                    -ldflags "-s -w -buildid= \
                    -X 'paqet/cmd/version.Version=${VERSION}' \
                    -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
                    -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
                    -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o paqet_darwin_${{ matrix.goarch }} ./cmd/main.go

                  chmod +x paqet_darwin_${{ matrix.goarch }}
                  tar -czvf dist/paqet-darwin-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.tar.gz \
                    paqet_darwin_${{ matrix.goarch }} \
                    README.md \
                    example/client.yaml.example \
                    example/server.yaml.example

            - name: Upload Artifact
              uses: actions/upload-artifact@v6
              with:
                  name: paqet-darwin-${{ matrix.goarch }}
                  path: dist/paqet-darwin-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.tar.gz
                  retention-days: 7

    release:
        runs-on: ubuntu-latest
        needs: [build-linux, build-darwin, build-windows]
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - name: Download all build artifacts
              uses: actions/download-artifact@v7
              with:
                  path: ./dist
                  pattern: paqet-*
                  merge-multiple: true

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  files: dist/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
